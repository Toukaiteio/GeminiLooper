# KeyManager 模块文档

## 概述

`KeyManager` 模块负责管理 API 密钥的生命周期，包括密钥的选择、使用计数、轮换以及处理错误。本次更新主要修复了潜在的锁嵌套问题，优化了429错误的处理逻辑。

## 主要修改

### 1. 死锁问题修复

- **问题描述**: 原代码中`handle_429_error`方法在持有锁的情况下调用`_rotate_key`方法，而`_rotate_key`方法也需要获取相同的锁，导致潜在的锁嵌套问题。
- **解决方案**:
  - 在`handle_429_error`中设置`need_rotation`标志位代替直接调用`_rotate_key`
  - 在`get_key`方法中添加对`need_rotation`标志的检查
  - 移除了`_rotate_key`方法中的锁，确保所有锁操作都是非嵌套的

### 2. 锁使用注意事项

- **单锁原则**: 任何时候只持有一个锁，避免锁嵌套
- **短持有时间**: 锁的持有时间应尽可能短
- **状态标志**: 使用状态标志(`need_rotation`)实现跨方法的同步需求
- **线程安全**: 所有共享数据的访问都必须在锁保护下进行

### 3. 429错误处理优化

- **模型切换**: 当429错误发生时，系统会尝试将当前使用的模型切换到`gemini-2.5-flash`
- **延迟轮换**: 使用状态标志实现延迟轮换，避免直接锁嵌套
- **日志增强**: 添加了更详细的调试日志，便于问题排查

### 4. 相关方法更新

- `__init__`: 新增`need_rotation`状态标志
- `get_key`: 添加对`need_rotation`标志的检查
- `handle_429_error`: 改为设置标志位而非直接调用`_rotate_key`
- `_rotate_key`: 移除了锁保护，由调用方确保线程安全

## 配置示例

```json
{
    "timezone": "America/Los_Angeles",
    "quota_reset_datetime": "2025-01-01 00:00",
    "default_model": "gemini-pro"
}
```

## 影响

- **线程安全**: 消除了潜在的锁嵌套问题，提高了线程安全性
- **稳定性**: 429错误处理更加健壮
- **可维护性**: 代码结构更清晰，便于后续维护
